name: 'Consistent Release'
author: 'Alexey Chekulaev'
description: 'Secure, repeatable releases to AWS and npm with semantic versioning, self-service releases and multiâ€‘artifact support'
branding:
  icon: package
  color: green
inputs:
  aws-account:
    description: 'AWS account to publish artifacts to. Not needed if there are no artifacts, just git tag'
    required: false
  aws-region:
    description: 'AWS region'
    required: false
  aws-role:
    description: 'IAM role to assume to publish, e.g., `ci/publisher`'
    required: false
  aws-codeartifact-domain:
    description: 'CodeArtifact domain name, e.g., `mycompany`'
    required: false
  aws-codeartifact-repository:
    description: 'CodeArtifact repository name, e.g., `maven`'
    required: false
  aws-codeartifact-maven:
    description: 'Two possible values: build and publish. publish - publish maven artifacts to AWS CodeArtifact, build - just access CodeArtifact to update version in pom.xml'
    required: false
  aws-ecr:
    description: 'If true, then push docker image to ECR'
    required: false
  aws-s3-bucket:
    description: 'Required if uploading to S3 (i.e. s3/ directory exists)'
    required: false
  aws-s3-dir:
    description: 'Allows you to specify S3 bucket directory to upload artifacts to. By default, just place in `bucket/{repo-name}/{version}/*`'
    required: false
  changelog-file:
    description: 'Changelog file path. Pass empty string to disable changelog generation'
    required: false
    default: 'CHANGELOG.md'
  changelog-title:
    description: 'Title of the changelog file (first line of the file)'
    required: false
    default: '# Changelog'
  dev-branch-prefix:
    description: 'Allows you to enforce branch prefix for dev-releases; this helps to write auto-disposal rules. Empty string disables enforcement'
    required: false
    default: 'feature/'
  dev-release:
    description: 'Allows you to create a temporary named release, mainly for dev testing. Implementation is different for all supported artifact types'
    required: false
    default: 'false'
  floating-tags:
    description: 'When the next version to be released is 1.2.4, then also release 1, 1.2, and latest. Not desired for public terraform modules'
    required: false
    default: 'true'
  java-cache:
    description: 'Enabled by default, specify empty string to disable caching'
    required: false
    default: 'maven'
  java-cache-dependency-path:
    description: 'see https://github.com/actions/setup-java "cache-dependency-path"'
    required: false
  java-distribution:
    description: 'Java distribution, use Temurin as it is pre-cached in ubuntu-latest'
    required: false
    default: 'temurin'
  java-version:
    description: 'Java version to use'
    required: false
    default: '21'
  node-version:
    description: 'Node.js version to publish npm packages, default is 22 because it is highest pre-cached in Ubuntu 24 (latest at time of writing)'
    required: false
    default: '22'
  npm-extra-deps:
    description: 'Additional semantic-release npm dependencies, needed to use non-default commit analyzer preset'
    required: false
  npm-visibility:
    description: 'Used together with env variable `NPM_TOKEN` to publish npm package. Specifies package visibility: public or private'
    required: false
    default: 'public'
  python-version:
    description: 'Python version, so far only used to bump version in pyproject.toml'
    required: false
    default: '3.13'
  pre-publish-script:
    description: 'Shell script that allows you to update version in custom file(s), not only files governed by build tool (pom.xml, package.json, etc)'
    required: false
  release-branches:
    description: 'semantic-release "branches" configuration'
    required: false
  release-channel:
    description: 'Repeat `.releaserc.json` `channel` behavior when set `version` explicitly'
    required: false
  release-gh:
    description: 'If true, then create a GitHub release with the same name as the tag'
    required: false
    default: 'true'
  release-plugins:
    description: 'semantic-release plugins configuration'
    required: false
  summary:
    description: 'Text to print in step summary. Can use `${version}` placeholder. Default is `### Released ${version}`. Set empty string to omit summary generation'
    required: false
    default: '### Released ${version}'
  tag-format:
    description: 'By default, the tag (version) has format `v1.0.0`. Use `${version}` to remove `v` prefix'
    required: false
  update-version-in-manifest:
    description: 'Update version in language-specific manifest files (e.g., pom.xml, package.json, pyproject.toml)'
    required: false
    default: 'true'
  version:
    description: 'Explicit version to use instead of auto-generation'
    required: false
  version-bump:
    description: 'Allows you to bump a version without semantic commits'
    required: false

runs:
  using: "composite"
  steps:

## Phase 1.1 - Validate event trigger

    - name: Validate trigger event
      shell: bash
      run: |
        # Validate trigger event
        if [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event_name }}" == "pull_request_target" ]]; then
          echo "Error: agilecustoms/release doesn't support on: pull_request/pull_request_target as a trigger" >&2; exit 1
        fi

## Phase 1.2 - Validate secrets (tokens) passed via env variables

    - name: Validate GH token
      if: inputs.release-gh == 'true' && inputs.dev-release != 'true' && !env.GH_TOKEN
      shell: bash
      run: |
        echo "Error: env variable GH_TOKEN is required to create GH release, you can pass $ {{ github.token }} or PAT" >&2; exit 1

    - name: Validate npm visibility
      if : env.NPM_TOKEN && ! (inputs.npm-visibility == 'public' || inputs.npm-visibility == 'private')
      shell: bash
      run: |
        echo "Error: npm-visibility must be either 'public' or 'private'" >&2; exit 1

## Phase 1.3 - Validate the rest of inputs, infer defaults

    - name: Init
      id: init
      shell: bash
      run: |
        # Init
        # Validate version: explicit version cannot be used with dev-release=true
        if [ -n "${{ inputs.version }}" ] && [ "${{ inputs.dev-release }}" = "true" ]; then
          echo "Error: explicit version cannot be used with dev-release=true" >&2
          exit 1
        fi
        # GITHUB_REPOSITORY has a format of 'company/service'
        service=$(echo "${GITHUB_REPOSITORY}" | awk -F'/' '{print $2}')
        echo "service=$service" >> $GITHUB_OUTPUT
        
        if [ "${{ inputs.dev-release }}" = "true" ] && [ -n "${{ inputs.dev-branch-prefix }}" ]; then
          branch="${GITHUB_REF#refs/heads/}"
          if [[ "$branch" != "${{ inputs.dev-branch-prefix }}"* ]]; then
            echo "Error: current branch '$branch' must start with '${{ inputs.dev-branch-prefix }}' when dev-release is true" >&2
            exit 1
          fi
        fi
        
        if [ -d s3 ]; then
          echo "aws_s3=true" >> $GITHUB_OUTPUT
        fi
        
        if [ -d s3 ] || [ "${{ inputs.aws-ecr }}" = "true" ] || [ -n "${{ inputs.aws-codeartifact-maven }}" ]; then
          if [ -z "${{ inputs.aws-account }}" ] || [ -z "${{ inputs.aws-region }}" ] || [ -z "${{ inputs.aws-role }}" ]; then
            echo "Error: aws-account, aws-region, and aws-role must all be provided" >&2
            exit 1
          fi
        fi

        if [ -n "${{ inputs.aws-codeartifact-maven }}" ]; then
          if [ -z "${{ inputs.aws-codeartifact-domain }}" ]; then
            echo "Error: aws-codeartifact-domain must be provided when aws-codeartifact-maven is set" >&2
            exit 1
          fi
        fi
        
        if [ -d s3 ] && [ -z "${{ inputs.aws-s3-bucket }}" ] ; then
          echo "Error: aws-s3-bucket must be provided when using S3" >&2
          exit 1
        fi

## Phase 2 - Release generation

    # the default Node is still 20, while release-gen uses Node24.
    # Also, it dynamically installs some extra deps via spawning 'npm' process, and some of these dependencies require Node >= 22
    - name: Set up Node
      uses: actions/setup-node@v5
      with:
        node-version: 24

    # CWD is /home/runner/work/release/release
    # generate a new version, release notes (available in file outputs.notes_file) and also update file CHANGELOG.md
    - name: Release generation
      id: release_gen
      if: inputs.dev-release != 'true'
      uses: agilecustoms/release-gen@v3.3.0
      with:
        changelog_file: ${{ inputs.changelog-file }}
        changelog_title: ${{ inputs.changelog-title }}
        floating_tags: ${{ inputs.floating-tags }}
        npm_extra_deps: ${{ inputs.npm-extra-deps }}
        release_branches: ${{ inputs.release-branches }}
        release_channel: ${{ inputs.release-channel }}
        release_plugins: ${{ inputs.release-plugins }}
        tag_format: ${{ inputs.tag-format }}
        version: ${{ inputs.version }}
        version_bump: ${{ inputs.version-bump }}

    - name: Finalize version and tags
      id: version
      shell: bash
      run: |
        # Finalize version and tags
        if [ "${{ inputs.dev-release }}" = "true" ]; then
          version="$(echo "${GITHUB_REF#refs/heads/}" | tr '/' '-')" # refs/heads/feature/abc -> feature-abc
          git_tags="$version"
          tags="$version"
        else
          version="${{ steps.release_gen.outputs.version }}"
          git_tags="${{ steps.release_gen.outputs.git_tags }}"
          tags="${{ steps.release_gen.outputs.tags }}"
        fi
        
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "git_tags=$git_tags" >> $GITHUB_OUTPUT
        echo "tags=$tags" >> $GITHUB_OUTPUT

## Phase 3 - Log in AWS

    - name: Log in AWS
      if: steps.init.outputs.aws_s3 || inputs.aws-ecr || inputs.aws-codeartifact-maven
      id: login-aws
      uses: aws-actions/configure-aws-credentials@v5.1.0 # TODO: floating tag v5 is available, but updates must be controlled
      with:
        aws-region: ${{ inputs.aws-region }}
        role-to-assume: arn:aws:iam::${{ inputs.aws-account }}:role/${{ inputs.aws-role }}
        output-credentials: true

    - name: Log in Amazon ECR
      if: inputs.aws-ecr
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2 # outputs.registry = {acc_id}.dkr.ecr.{region}.amazonaws.com

## Phase 4 - Prepare: mainly bump versions in language-specific files

    - name: Setup Java
      if: hashFiles('pom.xml') && inputs.dev-release != 'true'
      uses: actions/setup-java@v5
      with:
        java-version: ${{ inputs.java-version }}
        distribution: ${{ inputs.java-distribution }}
        cache: ${{ inputs.java-cache }}
        cache-dependency-path: ${{ inputs.java-cache-dependency-path }}

    - name: Setup Maven CodeArtifact
      if: inputs.aws-codeartifact-maven
      uses: agilecustoms/setup-maven-codeartifact@v2.1.1
      with:
        aws-account: ${{ inputs.aws-account }}
        aws-region: ${{ inputs.aws-region }}
        aws-role: ${{ inputs.aws-role }}
        aws-codeartifact-domain: ${{ inputs.aws-codeartifact-domain }}
        aws-codeartifact-repository: ${{ inputs.aws-codeartifact-repository || 'maven' }}
        aws-login: false # we already logged in AWS in a previous step
        java-setup: false

    - name: Update version in pom.xml
      if: inputs.update-version-in-manifest == 'true' && hashFiles('pom.xml') && inputs.dev-release != 'true'
      shell: bash
      run: |
        # Update version in pom.xml
        MVN=mvn
        if [[ -x ./mvnw ]]; then MVN=./mvnw; fi
        "$MVN" --no-transfer-progress versions:set -DnewVersion=${{ steps.version.outputs.version }} -DoldVersion=* -DgroupId=* -DartifactId=*
    # maven first creates effective pom, which requires resolving parent dependencies,
    # so unfortunately, even just to update versions in pom.xml, we need to have AWS CodeArtifact access :(

    - name: Setup Node
      if: hashFiles('package.json') && inputs.dev-release != 'true'
      uses: actions/setup-node@v5
      with:
        node-version: ${{ inputs.node-version }}
        registry-url: 'https://registry.npmjs.org'

    - name: Update version in package.json
      if: inputs.update-version-in-manifest == 'true' && hashFiles('package.json') && inputs.dev-release != 'true'
      shell: bash
      run: |
        # Update version in package.json
        npm version ${{ steps.version.outputs.version }} --no-git-tag-version

    - name: Setup Python
      if: hashFiles('pyproject.toml') && inputs.dev-release != 'true'
      uses: actions/setup-python@v6
      with:
        python-version: ${{ inputs.python-version }}

    - name: Update version in pyproject.toml
      if: inputs.update-version-in-manifest == 'true' && hashFiles('pyproject.toml') && inputs.dev-release != 'true'
      shell: bash
      run: |
        # Update version in pyproject.toml
        pipx install poetry
        poetry version ${{ steps.version.outputs.version }}

    - name: Pre-publish script
      if: inputs.pre-publish-script && inputs.dev-release != 'true'
      shell: bash
      run: |
        # Pre-publish script
        version=${{ steps.version.outputs.version }} && ${{ inputs.pre-publish-script }}

## Phase 5 - Publish artifacts

    - name: Publish to S3
      if: steps.init.outputs.aws_s3
      uses: agilecustoms/publish-s3@v2.1.4
      with:
        access-key-id: ${{ steps.login-aws.outputs.aws-access-key-id }}
        secret-access-key: ${{ steps.login-aws.outputs.aws-secret-access-key }}
        session-token: ${{ steps.login-aws.outputs.aws-session-token }}
        bucket: ${{ inputs.aws-s3-bucket }}
        bucket-dir: ${{ inputs.aws-s3-dir }}
        versions: ${{ steps.version.outputs.tags }}
        dev-release: ${{ inputs.dev-release }}

    - name: Push Docker image in ECR
      if: inputs.aws-ecr
      shell: bash
      run: |
        # Push Docker image in ECR
        service="${{ steps.init.outputs.service }}"
        ecr_image=${{ steps.login-ecr.outputs.registry }}/$service
        tags=$(echo "${{ steps.version.outputs.tags }}" | sed 's/[^ ]\+/imageTag=&/g')
        if [ "${{ inputs.dev-release }}" != "true" ]; then
          AWS_PAGER="" aws ecr batch-delete-image --repository-name $service --image-ids $tags || true
        fi
        tags="${{ steps.version.outputs.tags }}"
        for tag in $tags; do
          docker tag $service $ecr_image:$tag
        done
        docker push --all-tags $ecr_image

    # maven.main.skip=true (from Maven 3.9.0) to skip main sources compilation
    # maven.test.skip=true skips tests compilation and running (-DskipTests just skips running)
    # it does repackage though! (this is for good, bcz pom versions changed)
    # TODO: verify phase still run in build and release jobs
    # TODO: checkstyle and enforcer still run in both jobs
    - name: Publish maven to CodeArtifact
      if: inputs.aws-codeartifact-maven == 'publish' && inputs.dev-release != 'true'
      shell: bash
      run: |
        # Publish maven to CodeArtifact
        MVN=mvn
        if [[ -x ./mvnw ]]; then MVN=./mvnw; fi
        output=$($MVN --no-transfer-progress deploy -Dmaven.main.skip=true -Dmaven.test.skip=true 2>&1)
        error_code=$?
        echo "$output"
        if [ $error_code -ne 0 ] && [ "${{ github.run_attempt }}" != "1" ]; then
          if echo "$output" | grep -q "status code: 409"; then
            echo "Ignore error 'version already exist' for run attempt ${{ github.run_attempt }}"
            exit 0
          fi
        fi
        exit $error_code

    # get namespace from package.json: "name": "@company/my-package", then find mapping namespace => npm repo in .npmrc file
    # since there is no .npmrc file, do publish in npmjs.com npm registry
    - name: Publish in npmjs
      if: env.NPM_TOKEN && inputs.dev-release != 'true'
      shell: bash
      run: |
        # Publish in npmjs
        output=$(npm publish --access ${{ inputs.npm-visibility }} --tag ${{ steps.release_gen.outputs.channel }} 2>&1)
        error_code=$?
        echo "$output"
        if [ $error_code -ne 0 ] && [ "${{ github.run_attempt }}" != "1" ]; then
          if echo "$output" | grep -q "You cannot publish over the previously published versions"; then
            echo "Ignore error 'version already exist' for run attempt ${{ github.run_attempt }}"
            exit 0
          fi
        fi
        exit $error_code
      env:
        NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}

## Phase 6 - Git push

#    - name: Error to test publish idempotency
#      shell: bash
#      run: |
#        echo "intentional error" >&2
#        exit 1

    # This action does 'git push' at the end, so need write permission
    # Option 1. job permissions: contents: write
    #  (checkout@v <  6) .git/config is pre-configured with a ${{ github.token }} see misc/.git-config for example
    #  (checkout@v >= 6) credentials in a separate file under $RUNNER_TEMP
    # Option 2. use an explicit PAT passed as env variable 'GH_TOKEN' - need to apply it to make 'git push' work
    # Note: release-gen action (uses semantic-release under the hood) also calls some git commands,
    #       this step needs to be AFTER release-gen step, otherwise it reports 400 error: Duplicate header: "Authorization"
#    - name: Git authorization
#      if: env.GH_TOKEN
#      shell: bash
#      run: |
#         Git authorization
#        creds=$(echo -n "x-access-token:${GH_TOKEN}" | base64 -w 0)
#        git config http.https://github.com/.extraheader "AUTHORIZATION: basic $creds"

    - name: Git push
      if: inputs.dev-release != 'true'
      shell: bash
      run: |
        # Git push
        # fix any permission issues from earlier steps (npm version can create files with root permissions)
        sudo chown -R "$(id -un):$(id -gn)" .
        
        # stage files that might be modified/deleted by previous steps (ignore new files)
        git add -u
        # one legitime new file is CHANGELOG.md, which is created by release-gen step
        [ -f "${{ inputs.changelog-file }}" ] && git add "${{ inputs.changelog-file }}"
        if ! git diff --cached --quiet; then
          git status --porcelain
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Release version ${{ steps.version.outputs.version }} [skip ci]"
        else
          echo "No changes to commit."
        fi
        
        git tag -d ${{ steps.version.outputs.git_tags }} 2>/dev/null || true
        
        tags="${{ steps.version.outputs.git_tags }}"
        for tag in $tags; do
          git tag "$tag"
        done
        
        # turn "v1.2.3 v1.2 v1 channel" into "refs/tags/v1.2.3 refs/tags/v1.2 refs/tags/v1 refs/tags/channel"
        refs=$(echo "${{ steps.version.outputs.git_tags }}" |  sed 's/[^ ]\+/refs\/tags\/&/g')
        
        if [ -z "${{ inputs.version }}" ] && [ "${{ steps.release_gen.outputs.prerelease }}" = "true" ]; then
          git notes --ref semantic-release add -f -m '{"channels":["${{ steps.release_gen.outputs.channel }}"]}'
          refs="$refs refs/notes/semantic-release"
        fi
        
        # push changes along with tags atomically (use --force to overwrite old tags)
        if [ -n "${GH_TOKEN}" ]; then
          echo 'Alex4'
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
        fi
        git push --atomic origin ${{ github.ref_name }} $refs --force

## Phase 7 - GitHub Release

    # standard --generate-notes just add one line "**Full Changelog**: https://github.com/agilecustoms/{repo}/compare/v0.1.3...v0.1.4"
    - name: GitHub Release
      if: inputs.dev-release != 'true' && inputs.release-gh == 'true' && steps.release_gen.outputs.notes_tmp_file
      shell: bash
      run: |
        # GitHub Release
        gh release create ${{ steps.version.outputs.version }} --notes-file ${{ steps.release_gen.outputs.notes_tmp_file }}

## Phase 8 - Print summary

    - name: Summary
      if: inputs.summary && inputs.dev-release != 'true'
      shell: bash
      run: |
        # Summary
        version="${{ steps.version.outputs.version }}"
        summary="${{ inputs.summary }}"
        summary=$(eval echo "\"$summary\"")
        echo "$summary" >> $GITHUB_STEP_SUMMARY

outputs:
  version:
    description: "Newly released version"
    value: ${{ steps.version.outputs.version }}
